// Agent Actions - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

export type AgentAction = 
  | 'analyze'      // –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  | 'compare'      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  | 'summarize'    // –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
  | 'extract'      // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤
  | 'qa'           // –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

export interface AgentIntent {
  action: AgentAction
  target?: 'latest' | 'all' | 'specific'
  documentId?: string
  confidence: number
}

export interface SourceCitation {
  documentId: string
  documentTitle: string
  chunkId: string
  quote: string
  similarity: number
}

export interface AgentResponse {
  reply: string
  sources?: SourceCitation[]
  intent: AgentIntent
  conversationId?: string
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
 */
export function detectIntent(query: string): AgentIntent {
  const lowerQuery = query.toLowerCase()
  
  // –ê–Ω–∞–ª–∏–∑
  if (
    lowerQuery.includes('–∞–Ω–∞–ª–∏–∑') ||
    lowerQuery.includes('—Ä–∞–∑–±–µ—Ä–∏') ||
    lowerQuery.includes('–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π')
  ) {
    const isLatest = 
      lowerQuery.includes('–ø–æ—Å–ª–µ–¥–Ω') || 
      lowerQuery.includes('–Ω–æ–≤—ã–π') ||
      lowerQuery.includes('—Å–≤–µ–∂–∏–π')
    
    return {
      action: 'analyze',
      target: isLatest ? 'latest' : 'all',
      confidence: 0.9
    }
  }
  
  // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
  if (
    lowerQuery.includes('—Å—Ä–∞–≤–Ω–∏') ||
    lowerQuery.includes('–æ—Ç–ª–∏—á–∏') ||
    lowerQuery.includes('–ø–æ—Ö–æ–∂')
  ) {
    return {
      action: 'compare',
      target: 'all',
      confidence: 0.85
    }
  }
  
  // –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
  if (
    lowerQuery.includes('–∫—Ä–∞—Ç–∫–æ') ||
    lowerQuery.includes('—Ä–µ–∑—é–º') ||
    lowerQuery.includes('—Å—É—Ç—å') ||
    lowerQuery.includes('–≥–ª–∞–≤–Ω–æ–µ')
  ) {
    const isLatest = lowerQuery.includes('–ø–æ—Å–ª–µ–¥–Ω')
    return {
      action: 'summarize',
      target: isLatest ? 'latest' : 'all',
      confidence: 0.85
    }
  }
  
  // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  if (
    lowerQuery.includes('–∫–æ–≥–¥–∞') ||
    lowerQuery.includes('—Å–∫–æ–ª—å–∫–æ') ||
    lowerQuery.includes('–∫—Ç–æ') ||
    lowerQuery.includes('–≥–¥–µ') ||
    lowerQuery.includes('—Å–ø–∏—Å–æ–∫')
  ) {
    return {
      action: 'extract',
      confidence: 0.7
    }
  }
  
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –æ–±—ã—á–Ω—ã–π Q&A
  return {
    action: 'qa',
    confidence: 0.6
  }
}

/**
 * –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
 */
export const AGENT_PROMPTS = {
  analyze: `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫-—ç–∫—Å–ø–µ—Ä—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–í–∫–ª—é—á–∏ –≤ –∞–Ω–∞–ª–∏–∑:
1. **–ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞**: –û —á–µ–º —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
2. **–ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏**: 3-5 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–∑–∏—Å–æ–≤ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏
3. **–ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ö–∞–∫–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞/–ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è
4. **–í—ã–≤–æ–¥—ã**: –ö–∞–∫–∏–µ –≤—ã–≤–æ–¥—ã –¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ—Ä
5. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞**: –°–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –ø–æ–¥–ø—É–Ω–∫—Ç–∞–º–∏. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Ñ–∞–∫—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞.`,

  compare: `–¢—ã ‚Äî –∫–æ–º–ø–∞—Ä–∞—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –≤—ã—è–≤–∏—Ç—å –æ–±—â–µ–µ –∏ —Ä–∞–∑–ª–∏—á–∏—è.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
1. **–û–±—â–∏–µ —Ç–µ–º—ã**: –ß—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç—ã
2. **–ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è**: –ì–¥–µ –ø–æ–∑–∏—Ü–∏–∏/—Ñ–∞–∫—Ç—ã —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è
3. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã**: –ß—Ç–æ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
4. **–°–∏–Ω—Ç–µ–∑**: –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

–ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–∞—Ö.`,

  summarize: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—Å—Ç–∞.

–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ:
- **–û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ**: –°—É—Ç—å —Ç–µ–∫—Å—Ç–∞
- **–ö–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã**: 3-5 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –∏–¥–µ–π (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
- **–í—ã–≤–æ–¥**: –ì–ª–∞–≤–Ω—ã–π –º–µ—Å—Å–µ–¥–∂ –∞–≤—Ç–æ—Ä–∞

–û–±—ä–µ–º: –Ω–µ –±–æ–ª–µ–µ 150 —Å–ª–æ–≤. –°–æ—Ö—Ä–∞–Ω–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –∏–º–µ–Ω–∞, –¥–∞—Ç—ã.`,

  extract: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å (—Ñ–∞–∫—Ç, —á–∏—Å–ª–æ, –¥–∞—Ç–∞, –∏–º—è)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –æ—Ç–∫—É–¥–∞ —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ü–∏—Ç–∞—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã –µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π.`,

  qa: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞, —Å–∫–∞–∂–∏: "–Ø –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É –≤ —Å–≤–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π".`
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
 */
export function formatResponseWithSources(
  reply: string, 
  sources: SourceCitation[]
): string {
  if (!sources || sources.length === 0) return reply
  
  let formatted = reply + '\n\n---\n\n**üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:**\n\n'
  
  sources.forEach((source, i) => {
    formatted += `${i + 1}. **${source.documentTitle}**\n`
    formatted += `   üí¨ _"${source.quote.substring(0, 150)}${source.quote.length > 150 ? '...' : ''}"_\n`
    formatted += `   üéØ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${(source.similarity * 100).toFixed(0)}%\n\n`
  })
  
  return formatted
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏–∑ matches
 */
export function extractCitations(
  matches: any[],
  documentMap: Map<string, string>
): SourceCitation[] {
  return matches.slice(0, 3).map(match => ({
    documentId: match.document_id || match.id,
    documentTitle: documentMap.get(match.document_id || match.id) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç',
    chunkId: match.id,
    quote: match.content?.substring(0, 300) || '',
    similarity: match.similarity || 0
  }))
}
