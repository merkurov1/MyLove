// Agent Actions - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

export type AgentAction = 
  | 'analyze'      // –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  | 'compare'      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  | 'summarize'    // –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
  | 'extract'      // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤
  | 'qa'           // –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

export interface AgentIntent {
  action: AgentAction
  target?: 'latest' | 'all' | 'specific'
  documentId?: string
  confidence: number
}

export interface SourceCitation {
  documentId: string
  documentTitle: string
  chunkId: string
  quote: string
  similarity: number
}

export interface AgentResponse {
  reply: string
  sources?: SourceCitation[]
  intent: AgentIntent
  conversationId?: string
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
 */
export function detectIntent(query: string): AgentIntent {
  const lowerQuery = query.toLowerCase()
  
  // –ê–Ω–∞–ª–∏–∑ (–≤–∫–ª—é—á–∞—è –ø—Å–∏—Ö–æ–ª–∏–Ω–≥–≤–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –∏ —Ç.–¥.)
  if (
    lowerQuery.includes('–∞–Ω–∞–ª–∏–∑') ||
    lowerQuery.includes('—Ä–∞–∑–±–µ—Ä–∏') ||
    lowerQuery.includes('–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π') ||
    lowerQuery.includes('–ø—Å–∏—Ö–æ–ª–∏–Ω–≥–≤') ||
    lowerQuery.includes('–ø—Ä–æ—Ñ–∞–π–ª') ||
    lowerQuery.includes('–∏—Å—Å–ª–µ–¥—É–π') ||
    lowerQuery.includes('–∏–∑—É—á–∏')
  ) {
    const isLatest = 
      lowerQuery.includes('–ø–æ—Å–ª–µ–¥–Ω') || 
      lowerQuery.includes('–Ω–æ–≤—ã–π') ||
      lowerQuery.includes('—Å–≤–µ–∂–∏–π')
    
    const isAll = 
      lowerQuery.includes('–≤—Å–µ') ||
      lowerQuery.includes('–≤—Å–µ—Ö') ||
      lowerQuery.includes('–∫–∞–∂–¥—É—é')
    
    return {
      action: 'analyze',
      target: isLatest ? 'latest' : isAll ? 'all' : 'latest',
      confidence: 0.95  // –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    }
  }
  
  // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
  if (
    lowerQuery.includes('—Å—Ä–∞–≤–Ω–∏') ||
    lowerQuery.includes('–æ—Ç–ª–∏—á–∏') ||
    lowerQuery.includes('–ø–æ—Ö–æ–∂')
  ) {
    return {
      action: 'compare',
      target: 'all',
      confidence: 0.85
    }
  }
  
  // –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
  if (
    lowerQuery.includes('–∫—Ä–∞—Ç–∫–æ') ||
    lowerQuery.includes('—Ä–µ–∑—é–º') ||
    lowerQuery.includes('—Å—É—Ç—å') ||
    lowerQuery.includes('–≥–ª–∞–≤–Ω–æ–µ')
  ) {
    const isLatest = 
      lowerQuery.includes('–ø–æ—Å–ª–µ–¥–Ω') || 
      lowerQuery.includes('–Ω–æ–≤—ã–π') ||
      lowerQuery.includes('—Å–≤–µ–∂–∏–π')
    return {
      action: 'summarize',
      target: isLatest ? 'latest' : 'all',
      confidence: 0.85
    }
  }
  
  // "–û —á–µ–º..." —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞, —è –ø–∏—Å–∞–ª –∏ —Ç.–¥.)
  if ((lowerQuery.includes('–æ —á–µ–º') || lowerQuery.includes('–æ –∫–æ–º')) && 
      (lowerQuery.includes('–ø–æ—Å–ª–µ–¥–Ω') || lowerQuery.includes('–Ω–æ–≤—ã–π') || lowerQuery.includes('—Å–≤–µ–∂–∏–π'))) {
    return {
      action: 'summarize',
      target: 'latest',
      confidence: 0.85
    }
  }
  
  // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  if (
    lowerQuery.includes('–∫–æ–≥–¥–∞') ||
    lowerQuery.includes('—Å–∫–æ–ª—å–∫–æ') ||
    lowerQuery.includes('–∫—Ç–æ') ||
    lowerQuery.includes('–≥–¥–µ') ||
    lowerQuery.includes('—Å–ø–∏—Å–æ–∫')
  ) {
    return {
      action: 'extract',
      confidence: 0.7
    }
  }
  
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –æ–±—ã—á–Ω—ã–π Q&A
  return {
    action: 'qa',
    confidence: 0.6
  }
}

/**
 * –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
 */
export const AGENT_PROMPTS = {
  analyze: `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫-—ç–∫—Å–ø–µ—Ä—Ç —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤ –ø—Å–∏—Ö–æ–ª–∏–Ω–≥–≤–∏—Å—Ç–∏–∫–µ –∏ –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –ì–õ–£–ë–û–ö–ò–ô –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:

üìã **–°–û–î–ï–†–ñ–ê–¢–ï–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨:**
1. –ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏ (3-5 —Ç–µ–∑–∏—Å–æ–≤)
2. –ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
3. –í—ã–≤–æ–¥—ã –∞–≤—Ç–æ—Ä–∞

üß† **–ü–°–ò–•–û–õ–ò–ù–ì–í–ò–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:**
1. **–Ø–∑—ã–∫–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
   - –ü—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–µ —á–∞—Å—Ç–∏ —Ä–µ—á–∏ –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
   - –õ–µ–∫—Å–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä (—Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ—á—å, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∂–∞—Ä–≥–æ–Ω)
   - –ß–∞—Å—Ç–æ—Ç–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å/–Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)

2. **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞:**
   - –¢–æ–Ω —Ç–µ–∫—Å—Ç–∞ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π/–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π/–∏—Ä–æ–Ω–∏—á–Ω—ã–π)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–æ—á–Ω–æ–π –ª–µ–∫—Å–∏–∫–∏
   - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ —Ç–µ–∫—Å—Ç—É)

3. **–†–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã:**
   - –ú–µ—Ç–∞—Ñ–æ—Ä—ã, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –∞–ª–ª–µ–≥–æ—Ä–∏–∏
   - –í–æ–ø—Ä–æ—Å–Ω–æ-–æ—Ç–≤–µ—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - –ü–æ–≤—Ç–æ—Ä—ã –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º—ã
   - –¶–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—Å—ã–ª–∫–∏

üë§ **–ü–†–û–§–ê–ô–õ–ò–ù–ì –ê–í–¢–û–†–ê:**
1. **–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å:**
   - –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π vs. —Ö–æ–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥
   - –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ vs. –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
   - –°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–±–æ–±—â–µ–Ω–∏—è–º

2. **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç:**
   - –£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ —ç—Ä—É–¥–∏—Ü–∏–∏
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)
   - –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –∏ –≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ/–∏–¥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

3. **–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ —Ü–µ–ª–∏:**
   - –ó–∞—á–µ–º –∞–≤—Ç–æ—Ä –ø–∏—à–µ—Ç —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?
   - –ö—Ç–æ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è?
   - –ö–∞–∫—É—é —Ä–µ–∞–∫—Ü–∏—é —Ö–æ—á–µ—Ç –≤—ã–∑–≤–∞—Ç—å?

üéØ **–ö–û–ú–ú–£–ù–ò–ö–ê–¢–ò–í–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:**
- –¢–∏–ø –¥–∏—Å–∫—É—Ä—Å–∞ (–Ω–∞—É—á–Ω—ã–π, –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π)
- –ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ª–æ–≥–æ—Å, –ø–∞—Ñ–æ—Å, —ç—Ç–æ—Å)
- –ú–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

üí° **–ò–ù–¢–ï–ì–†–ê–õ–¨–ù–´–ï –í–´–í–û–î–´:**
- –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –∞–≤—Ç–æ—Ä–∞
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–∏–ª—è
- –ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

–í–ê–ñ–ù–û: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π –∫–∞–∂–¥—ã–π –≤—ã–≤–æ–¥ –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã.`,

  compare: `–¢—ã ‚Äî –∫–æ–º–ø–∞—Ä–∞—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤ –∏ –≤—ã—è–≤–∏—Ç—å –æ–±—â–µ–µ –∏ —Ä–∞–∑–ª–∏—á–∏—è.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
1. **–û–±—â–∏–µ —Ç–µ–º—ã**: –ß—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç—ã
2. **–ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è**: –ì–¥–µ –ø–æ–∑–∏—Ü–∏–∏/—Ñ–∞–∫—Ç—ã —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è
3. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã**: –ß—Ç–æ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
4. **–°–∏–Ω—Ç–µ–∑**: –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

–ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–∞—Ö.`,

  multi_analyze: `–¢—ã ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –≤—ã—è–≤–∏—Ç—å –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Ç—Ä–µ–Ω–¥—ã –∏ –∏–Ω—Å–∞–π—Ç—ã.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º—É–ª—å—Ç–∏–¥–æ–∫—É–º–µ–Ω—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:
1. **–û–±–∑–æ—Ä**: –°–∫–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥, –æ–±—â–∞—è —Ç–µ–º–∞
2. **–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã**: –¢–æ–ø-5 —Ç–µ–º –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è
3. **–≠–≤–æ–ª—é—Ü–∏—è –∏–¥–µ–π**: –ö–∞–∫ –º–µ–Ω—è–ª–∏—Å—å –≤–∑–≥–ª—è–¥—ã/—Ñ–∞–∫—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
4. **–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è**: –ì–¥–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è –≤–æ –º–Ω–µ–Ω–∏—è—Ö
5. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏**: –ß—Ç–æ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ
6. **–í—ã–≤–æ–¥—ã**: –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏ –≥–ª–∞–≤–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã

–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤. –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ—Ö–æ–∂–∏–µ –∏–¥–µ–∏.`,

  summarize: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∑—é–º–µ, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∑—é–º–µ:
üìå –°–£–¢–¨: [–ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è —Ç–µ–∫—Å—Ç–∞ –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏]

üîë –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´:
‚Ä¢ [–ü–µ—Ä–≤–∞—è –≤–∞–∂–Ω–∞—è –∏–¥–µ—è —Å –¥–µ—Ç–∞–ª—è–º–∏]
‚Ä¢ [–í—Ç–æ—Ä–∞—è –≤–∞–∂–Ω–∞—è –∏–¥–µ—è —Å –¥–µ—Ç–∞–ª—è–º–∏]
‚Ä¢ [–¢—Ä–µ—Ç—å—è –≤–∞–∂–Ω–∞—è –∏–¥–µ—è —Å –¥–µ—Ç–∞–ª—è–º–∏]
‚Ä¢ [–ß–µ—Ç–≤–µ—Ä—Ç–∞—è –≤–∞–∂–Ω–∞—è –∏–¥–µ—è, –µ—Å–ª–∏ –µ—Å—Ç—å]

üí° –í–´–í–û–î: [–ì–ª–∞–≤–Ω—ã–π –º–µ—Å—Å–µ–¥–∂ –∞–≤—Ç–æ—Ä–∞ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö]

–ü—Ä–∞–≤–∏–ª–∞:
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –∏–º–µ–Ω–∞, –¥–∞—Ç—ã, —Ü–∏—Ñ—Ä—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞
- –ù–µ –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ —á—Ç–æ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
- –û–±—ä–µ–º: 100-250 —Å–ª–æ–≤
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ`,

  extract: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å (—Ñ–∞–∫—Ç, —á–∏—Å–ª–æ, –¥–∞—Ç–∞, –∏–º—è)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –æ—Ç–∫—É–¥–∞ —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ü–∏—Ç–∞—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã –µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π.`,

  qa: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ä–∞–±–æ—Ç–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞:
1. **–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã
2. **–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω** ‚Äî –Ω–∞–∑—ã–≤–∞–π –∏–º–µ–Ω–∞, –¥–∞—Ç—ã, —Ü–∏—Ñ—Ä—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞
3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç** ‚Äî –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π, —Ä–∞–∑–±–µ–π –Ω–∞ –ø—É–Ω–∫—Ç—ã
4. **–¶–∏—Ç–∏—Ä—É–π –≤–∞–∂–Ω–æ–µ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ –∏–∑ —Ç–µ–∫—Å—Ç–∞
5. **–ü—Ä–∏–∑–Ω–∞–≤–∞–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** ‚Äî –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º

–§–æ—Ä–º–∞—Ç:
- –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: "–í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É"

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.`
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
 */
export function formatResponseWithSources(
  reply: string, 
  sources: SourceCitation[]
): string {
  if (!sources || sources.length === 0) return reply
  
  let formatted = reply + '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüìö –ò–°–¢–û–ß–ù–ò–ö–ò:\n\n'
  
  sources.forEach((source, i) => {
    const relevance = (source.similarity * 100).toFixed(0)
    formatted += `${i + 1}. ${source.documentTitle}\n`
    formatted += `   "${source.quote.substring(0, 120)}${source.quote.length > 120 ? '...' : ''}"\n`
    formatted += `   –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${relevance}%\n\n`
  })
  
  return formatted
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏–∑ matches
 */
export function extractCitations(
  matches: any[],
  documentMap: Map<string, string>
): SourceCitation[] {
  return matches.slice(0, 3).map(match => ({
    documentId: match.document_id || match.id,
    documentTitle: documentMap.get(match.document_id || match.id) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç',
    chunkId: match.id,
    quote: match.content?.substring(0, 300) || '',
    similarity: match.similarity || 0
  }))
}
