// Agent Actions - определение намерений пользователя

export type AgentAction = 
  | 'analyze'      // Глубокий анализ документа
  | 'compare'      // Сравнение документов
  | 'summarize'    // Краткое содержание
  | 'extract'      // Извлечение фактов
  | 'qa'           // Простой вопрос-ответ (по умолчанию)

export interface AgentIntent {
  action: AgentAction
  target?: 'latest' | 'all' | 'specific'
  documentId?: string
  confidence: number
}

/**
 * Определяет намерение пользователя из запроса
 */
export function detectIntent(query: string): AgentIntent {
  const lowerQuery = query.toLowerCase()
  
  // Анализ
  if (
    lowerQuery.includes('анализ') ||
    lowerQuery.includes('разбери') ||
    lowerQuery.includes('проанализируй')
  ) {
    const isLatest = 
      lowerQuery.includes('последн') || 
      lowerQuery.includes('новый') ||
      lowerQuery.includes('свежий')
    
    return {
      action: 'analyze',
      target: isLatest ? 'latest' : 'all',
      confidence: 0.9
    }
  }
  
  // Сравнение
  if (
    lowerQuery.includes('сравни') ||
    lowerQuery.includes('отличи') ||
    lowerQuery.includes('похож')
  ) {
    return {
      action: 'compare',
      target: 'all',
      confidence: 0.85
    }
  }
  
  // Суммаризация
  if (
    lowerQuery.includes('кратко') ||
    lowerQuery.includes('резюм') ||
    lowerQuery.includes('суть') ||
    lowerQuery.includes('главное')
  ) {
    const isLatest = lowerQuery.includes('последн')
    return {
      action: 'summarize',
      target: isLatest ? 'latest' : 'all',
      confidence: 0.85
    }
  }
  
  // Извлечение данных
  if (
    lowerQuery.includes('когда') ||
    lowerQuery.includes('сколько') ||
    lowerQuery.includes('кто') ||
    lowerQuery.includes('где') ||
    lowerQuery.includes('список')
  ) {
    return {
      action: 'extract',
      confidence: 0.7
    }
  }
  
  // По умолчанию - обычный Q&A
  return {
    action: 'qa',
    confidence: 0.6
  }
}

/**
 * Системные промпты для разных типов действий
 */
export const AGENT_PROMPTS = {
  analyze: `Ты — аналитик-эксперт. Твоя задача — сделать глубокий структурированный анализ предоставленного текста.

Включи в анализ:
1. **Главная тема**: О чем текст в одном предложении
2. **Ключевые идеи**: 3-5 основных тезисов с пояснениями
3. **Аргументация**: Какие доказательства/примеры приводятся
4. **Выводы**: Какие выводы делает автор
5. **Критическая оценка**: Сильные/слабые стороны аргументации

Используй структуру с заголовками и подпунктами. Будь конкретен и ссылайся на факты из текста.`,

  compare: `Ты — компаративный аналитик. Твоя задача — сравнить несколько текстов и выявить общее и различия.

Структура сравнения:
1. **Общие темы**: Что объединяет тексты
2. **Ключевые различия**: Где позиции/факты расходятся
3. **Уникальные элементы**: Что есть только в одном тексте
4. **Синтез**: Общая картина из всех источников

Будь объективен, не добавляй информацию которой нет в текстах.`,

  summarize: `Ты — эксперт по суммаризации. Твоя задача — создать краткое, но информативное резюме текста.

Формат резюме:
- **Одно предложение**: Суть текста
- **Ключевые пункты**: 3-5 самых важных идей (маркированный список)
- **Вывод**: Главный месседж автора

Объем: не более 150 слов. Сохрани важные факты, имена, даты.`,

  extract: `Ты — эксперт по извлечению данных. Твоя задача — найти и структурировано представить конкретную информацию.

Формат ответа:
- Прямой ответ на вопрос (факт, число, дата, имя)
- Контекст: откуда эта информация (цитата из текста)
- Дополнительно: связанные факты если релевантны

Если информации нет — скажи честно. Не выдумывай.`,

  qa: `Ты — экспертный ассистент. Используй только предоставленный контекст для ответа. Отвечай кратко и по делу на русском языке. Если в контексте нет информации для ответа, скажи: "Я не нашел информации по вашему вопросу в своей базе знаний".`
}
