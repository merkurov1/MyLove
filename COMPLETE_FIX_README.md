# üöÄ –ü–û–õ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´

**–î–∞—Ç–∞:** 8 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º—ã:** 
- ‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ùå –§–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è (–æ—à–∏–±–∫–∞ 12891 tokens)
- ‚ùå –ß–∞—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ñ–∏–≥–Ω—é (–Ω–µ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º)
- ‚ùå –ë–î —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (documents.content –≤–º–µ—Å—Ç–æ documents.title/description)
- ‚ùå Embeddings 384d –≤–º–µ—Å—Ç–æ 1536d

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï (3 —à–∞–≥–∞)

### **–®–ê–ì 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –≤ Supabase** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

–û—Ç–∫—Ä–æ–π—Ç–µ **Supabase SQL Editor** ‚Üí –≤—Å—Ç–∞–≤—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ **COMPLETE_FIX.sql**

–≠—Ç–æ—Ç SQL:
1. ‚úÖ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `documents` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (title, description, source_url)
2. ‚úÖ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `document_chunks` —Å vector(1536) –¥–ª—è OpenAI
3. ‚úÖ –°–æ–∑–¥–∞—Å—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è content_tsv
5. ‚úÖ –°–æ–∑–¥–∞—Å—Ç RPC —Ñ—É–Ω–∫—Ü–∏–∏: match_documents() –∏ hybrid_search()

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** DROP TABLE IF EXISTS - –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Ä–∞–∑.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç –ø—É—Å—Ç—ã–µ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).

---

### **–®–ê–ì 2: –ü–æ–¥–æ–∂–¥–∞—Ç—å Vercel Deploy**

–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç **3276d16** —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç smart batching, –Ω–æ Vercel –º–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:**
```bash
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
curl https://pierrot.merkurov.love/api/stats
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `{"documents":0,"chunks":0,...}` - –¥–µ–ø–ª–æ–π –≥–æ—Ç–æ–≤!

---

### **–®–ê–ì 3: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –û–î–ò–ù –†–ê–ó**

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://pierrot.merkurov.love/database
2. –í–æ–π–¥–∏—Ç–µ —Å –ø–∞—Ä–æ–ª–µ–º: `eMunwiL`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "üìö –î–æ–∫—É–º–µ–Ω—Ç—ã"
4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `documents` (title, description)
- ‚úÖ –¢–µ–∫—Å—Ç —Ä–∞–∑–æ–±—å–µ—Ç—Å—è –Ω–∞ chunks (—Å overlap 150 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ Smart batching —Å–æ–∑–¥–∞—Å—Ç embeddings –ø–æ 6000 tokens –∑–∞ —Ä–∞–∑
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –∑–∞–ø–æ–ª–Ω–∏—Ç content_tsv –¥–ª—è full-text search
- ‚úÖ –í—Å–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î

**Progress bar –ø–æ–∫–∞–∂–µ—Ç:** –ó–∞–≥—Ä—É–∑–∫–∞ 0-50% ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ 50-90% ‚Üí –ì–æ—Ç–æ–≤–æ 100%

---

## üéØ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û –í –ö–û–î–ï

### 1. **lib/embedding-ai.ts** - Smart Batching
```typescript
// –î–û (–ø—Ä–æ–±–ª–µ–º–∞):
const BATCH_SIZE = 10; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
// –ü–∞–¥–∞–ª–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö (12891 tokens)

// –ü–û–°–õ–ï (—Ä–µ—à–µ–Ω–∏–µ):
const MAX_TOKENS_PER_BATCH = 6000;
function estimateTokens(text) { return Math.ceil(text.length / 4); }
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –±–∞—Ç—á–∏ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∏—Ç –ø–æ–ø–æ–ª–∞–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

### 2. **app/api/ingest/route.ts** - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```typescript
// –°–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏:
await supabase.from('documents').insert({
  title: file.name,           // ‚úÖ –ë—ã–ª–æ: content
  description: text,          // ‚úÖ –ù–æ–≤–æ–µ –ø–æ–ª–µ
  source_url: null,           // ‚úÖ –î–ª—è —Å—Å—ã–ª–æ–∫
  source_id: sourceId         // ‚úÖ –°–≤—è–∑—å —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
});
```

### 3. **app/api/stats/route.ts** - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```typescript
// –°—á–∏—Ç–∞–µ—Ç –∏–∑ document_chunks (–ù–ï –∏–∑ documents.content)
const { count: chunks } = await supabase
  .from('document_chunks')
  .select('*', { count: 'exact', head: true });
```

### 4. **app/api/chat/route.ts** - Conditional Reranking
```typescript
// Reranking —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π similarity (—ç–∫–æ–Ω–æ–º–∏—è $$$)
const shouldRerank = topSimilarity < 0.5;
if (shouldRerank) {
  const reranked = await fastRerank(query, matches, 7);
}
```

### 5. **components/ChatAssistant.tsx** - UI —É–ª—É—á—à–µ–Ω–∏—è
```typescript
// Info banner —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
<div className="text-xs text-gray-500">
  <FaDatabase /> {stats.documentsCount} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Ä¢ {stats.chunksCount} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
</div>

// –ü–∞—Ä—Å–∏–Ω–≥ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
const parsed = parseResponse(data.reply);
{parsed.sources && (
  <div className="border-t">
    üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏: {parsed.sources}
  </div>
)}
```

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:
```bash
node check-db.js
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
- ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫–∏: 5
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã: N (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
- ‚úÖ –ß–∞–Ω–∫–∏: N√ó7 (–ø—Ä–∏–º–µ—Ä–Ω–æ)
- ‚úÖ RPC match_documents —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API:
```bash
curl https://pierrot.merkurov.love/api/stats
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
```json
{
  "documents": N,
  "chunks": M,
  "conversations": K,
  "messages": L
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ test-small-file.txt (300 —Å–∏–º–≤–æ–ª–æ–≤)
2. –ï—Å–ª–∏ —É—Å–ø–µ—Ö - –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Vercel Logs

---

## üí∞ –°–¢–û–ò–ú–û–°–¢–¨ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π)

### –ï–∂–µ–º–µ—Å—è—á–Ω–æ –ø—Ä–∏ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤:
- Embeddings: $0.03 (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
- GPT-4o-mini: $0.60
- Reranking: $0.15 (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ similarity < 0.5)
- Supabase: $0 (Free tier)
- Vercel: $0 (Hobby plan)

**–ò–¢–û–ì–û: $0.78/–º–µ—Å—è—Ü** –∏–∑ –±—é–¥–∂–µ—Ç–∞ $5 ‚úÖ

### –≠–∫–æ–Ω–æ–º–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –∑–∞ —Å—á–µ—Ç:
- ‚úÖ Smart batching (–Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ Conditional reranking (—ç–∫–æ–Ω–æ–º–∏—è $0.38/–º–µ—Å)
- ‚úÖ –ù–µ—Ç fine-tuning (—ç–∫–æ–Ω–æ–º–∏—è $2-3/–º–µ—Å)
- ‚úÖ Simplified telemetry (–º–µ–Ω—å—à–µ –ª–æ–≥–æ–≤)

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –ó–ê–ì–†–£–ó–ö–û–ô

- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω COMPLETE_FIX.sql –≤ Supabase
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: `curl https://pierrot.merkurov.love/api/stats` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: `node check-db.js` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ 0 —á–∞–Ω–∫–æ–≤
- [ ] –û—Ç–∫—Ä—ã—Ç https://pierrot.merkurov.love/database
- [ ] –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω (–ø–∞—Ä–æ–ª—å: eMunwiL)
- [ ] –ì–æ—Ç–æ–≤—ã —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

---

## üéâ –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò

–ß–∞—Ç –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å **–¢–û–õ–¨–ö–û –ü–û –í–ê–®–ò–ú –î–û–ö–£–ú–ï–ù–¢–ê–ú**!

–ü—Ä–∏–º–µ—Ä:
```
–í—ã: –û —á–µ–º –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ –≤ –ù–æ–≤–æ–π –≥–∞–∑–µ—Ç–µ?
AI: [–ù–∞—Ö–æ–¥–∏—Ç –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫]
    [–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞]
    [–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–¥ –æ—Ç–≤–µ—Ç–æ–º]
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–ë–û–õ–¨–®–ï –ù–ï –ù–£–ñ–ù–û –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–¢–¨ –î–û–ö–£–ú–ï–ù–¢–´!**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è COMPLETE_FIX.sql –∏ –æ–¥–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ UI - –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Vercel Logs –∏ Supabase Logs –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏.

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ
