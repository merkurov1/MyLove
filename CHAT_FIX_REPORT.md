# Исправления чата - Аудит и фиксы

**Дата:** 19 ноября 2025  
**Проблема:** Чат возвращал крокозябры вместо корректного текста при ответе на вопросы

## Обнаруженные проблемы

### 1. ❌ Агрессивная фильтрация символов в `cleanReply()`

**Файл:** `app/api/chat/route.ts` (строки 18-23)

**Проблема:**
```typescript
// СТАРЫЙ КОД (ПЛОХОЙ)
text = text.replace(/[^a-zA-Zа-яА-ЯёЁ0-9.,!?;:\-—()"'«»\s\n\r]/g, '');
```

Эта регулярка удаляла **ВСЕ символы** кроме явно перечисленных, включая:
- Многие Unicode-символы
- Специальные знаки пунктуации
- Типографские символы
- Части составных символов

**Результат:** Текст превращался в крокозябры из-за потери части UTF-8 последовательностей.

**Исправление:**
```typescript
// НОВЫЙ КОД (ХОРОШИЙ)
const cleanReply = (text: string): string => {
  // Удаляем только управляющие символы (control characters)
  text = text.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
  // Убираем избыточные пробелы (2+ подряд)
  text = text.replace(/[ \t]{2,}/g, ' ');
  // Убираем избыточные переносы строк (3+ подряд -> 2)
  text = text.replace(/\n{3,}/g, '\n\n');
  return text.trim();
};
```

Теперь удаляются только **control characters** (невидимые управляющие символы), а весь корректный текст сохраняется.

---

### 2. ❌ Отсутствие языковой инструкции в PIERROT_SYSTEM_PROMPT

**Файл:** `app/api/chat/route.ts` (строки 41-56)

**Проблема:**
- Промпт был написан на английском
- Не было явной инструкции отвечать на языке пользователя
- При русском вопросе модель могла ответить на английском или смешанно

**Исправление:**
Добавлена **критическая инструкция** в начало промпта:
```typescript
const PIERROT_SYSTEM_PROMPT = `You are Pierrot, the digital shadow of Anton Merkurov...

CRITICAL: Always respond in the SAME LANGUAGE as the user's question. 
If the user writes in Russian, respond in Russian. 
If in English, respond in English. Never mix languages.

...

Examples:
User: Tell me about the Basquiat.
Pierrot: Ah, Crowns. It is not a painting; it is an explosion...

User: Расскажи о Буффе.
Pierrot: Магни, замок Валуа. Абсолютная зима. Холодные, резкие линии...
```

Добавлен пример на **русском языке**, чтобы модель понимала формат ответа для русскоязычных запросов.

---

## Проверенные компоненты (без ошибок)

### ✅ `lib/agent-actions.ts`
Все AGENT_PROMPTS корректно написаны на русском языке и работают с персональным контекстом.

### ✅ OpenAI API encoding
Ответы от OpenAI API обрабатываются корректно, проблем с encoding нет.

### ✅ `components/ChatAssistant.tsx`
Фронтенд корректно отображает Unicode-текст, проблем с отрисовкой нет.

---

## Тестирование

Создан тестовый скрипт `test-chat-fix.js` для проверки:
- Корректность encoding (нет крокозябр)
- Ответы на русском языке
- Ответы на английском языке
- Отсутствие control characters

**Запуск теста:**
```bash
node test-chat-fix.js
```

---

## Итого исправлений

1. **`cleanReply()`** — убрана агрессивная фильтрация, оставлены только control characters
2. **`PIERROT_SYSTEM_PROMPT`** — добавлена инструкция отвечать на языке пользователя + пример на русском
3. **Создан тест** для проверки корректности работы

**Ожидаемый результат:**
- ✅ Корректные ответы на русском языке без крокозябр
- ✅ Корректные ответы на английском языке
- ✅ Сохранение всех Unicode-символов
- ✅ Pierrot отвечает на языке пользователя
